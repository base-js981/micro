version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: micro-postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: micro
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: micro-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    container_name: micro-auth-service
    environment:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: postgresql://user:password@postgres:5432/micro?schema=public
      JWT_SECRET: change-me-in-production
      JWT_EXPIRES_IN: 15m
      JWT_REFRESH_EXPIRES_IN: 7d
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  file-storage-service:
    build:
      context: .
      dockerfile: services/file-storage-service/Dockerfile
    container_name: micro-file-storage-service
    environment:
      NODE_ENV: development
      PORT: 5001
      # Storage Configuration
      # Option 1: Local Storage (default)
      STORAGE_TYPE: local
      LOCAL_STORAGE_PATH: /app/storage
      LOCAL_STORAGE_BASE_URL: http://localhost:5001/files
      # Option 2: S3-compatible Storage (uncomment and configure)
      # STORAGE_TYPE: s3
      # S3_ACCESS_KEY_ID: your-access-key-id
      # S3_SECRET_ACCESS_KEY: your-secret-access-key
      # S3_BUCKET: file-storage
      # S3_REGION: us-east-1
      # # For S3-compatible services (MinIO, DigitalOcean Spaces, etc.)
      # S3_ENDPOINT: http://minio:9000  # MinIO endpoint example
      # S3_FORCE_PATH_STYLE: true  # Required for MinIO and some S3-compatible services
      # # For AWS S3 (leave S3_ENDPOINT empty)
      # # S3_ENDPOINT:
      # # S3_FORCE_PATH_STYLE: false
      REDIS_HOST: redis
      REDIS_PORT: 6379
      NGINX_USER_ID_HEADER: X-User-Id
      NGINX_USER_EMAIL_HEADER: X-User-Email
      NGINX_USER_ROLES_HEADER: X-User-Roles
    ports:
      - "5001:5001"
    volumes:
      - file_storage_data:/app/storage
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Example: File Storage Service with S3-compatible (MinIO) configuration
  # Uncomment and modify as needed
  # file-storage-service-s3:
  #   build:
  #     context: .
  #     dockerfile: services/file-storage-service/Dockerfile
  #   container_name: micro-file-storage-service-s3
  #   environment:
  #     NODE_ENV: development
  #     PORT: 5001
  #     # S3-compatible Storage Configuration
  #     STORAGE_TYPE: s3
  #     S3_ACCESS_KEY_ID: minioadmin
  #     S3_SECRET_ACCESS_KEY: minioadmin
  #     S3_BUCKET: file-storage
  #     S3_REGION: us-east-1
  #     S3_ENDPOINT: http://minio:9000  # MinIO service name in docker-compose
  #     S3_FORCE_PATH_STYLE: true  # Required for MinIO
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     NGINX_USER_ID_HEADER: X-User-Id
  #     NGINX_USER_EMAIL_HEADER: X-User-Email
  #     NGINX_USER_ROLES_HEADER: X-User-Roles
  #   ports:
  #     - "5002:5001"  # Different port to avoid conflict
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #     minio:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5001/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s

  # MinIO - S3-compatible object storage (optional, for local development)
  # Uncomment if you want to use MinIO for S3-compatible storage
  # minio:
  #   image: minio/minio:latest
  #   container_name: micro-minio
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #   command: server /data --console-address ":9001"
  #   ports:
  #     - "9000:9000"  # MinIO API
  #     - "9001:9001"  # MinIO Console
  #   volumes:
  #     - minio_data:/data
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
  #     interval: 30s
  #     timeout: 20s
  #     retries: 3

  # nginx:
  #   image: nginx:alpine
  #   container_name: micro-nginx
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/jwt-auth.conf:/etc/nginx/conf.d/jwt-auth.conf:ro
  #     - ./nginx/upstreams.conf:/etc/nginx/conf.d/upstreams.conf:ro
  #     # For Lua script (if using OpenResty)
  #     # - ./nginx/lua:/etc/nginx/lua:ro
  #   depends_on:
  #     - auth-service
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

volumes:
  postgres_data:
  file_storage_data:
  # minio_data:  # Uncomment if using MinIO

